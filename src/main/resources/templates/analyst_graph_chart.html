<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Graph/Chart for Market Price </title>
  <link rel="stylesheet" href="analyst.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <a href="/analyst_dashboard">Dashboard</a>
    <a href="/analyst_market_prices">Market Price for Crops</a>
      <a href="/analyst_input_market_data" >Input Market Data</a>
    <a href="/analyst_graph_chart" class="active">Graph By Date For</a>
    <a href="/analyst_index">Sign Out</a>
    <a href="/agent_All_Harvest" >Harvest Information Table</a>
    <a href="/agent_bids_info" >Harvest and Bids Information</a>
  </aside>
  <!-- Main Content -->
  <main class="main-content">
    <h1>Graph/Chart</h1>
    <div class="filter-section">
      <label for="location">Select Location:</label>
      <select id="location" name="location">
        <option value="" disabled selected>Select Location</option>
        <option th:each="location : ${locations}"
                th:value="${location.area_code}"
                th:text="${location.area_location}">
        </option>
      </select>
      <!-- Dropdown for Crops -->
      <label for="crop">Select Crop:</label>
      <select id="crop" name="crop">
        <option value="" disabled selected>Select Crop</option>
        <option th:each="crop : ${crops}"
                th:value="${crop.cropID}"
                th:text="${crop.crop_name}">
        </option>
      </select>
      <label for="priceType">Select Price Type:</label>
      <select id="priceType" name="priceType">
        <option value="" disabled selected>Select Price Type</option>
        <option value="high">Show By Highest price</option>
        <option value="low">Show By lowest price</option>
      </select>

      <!-- Dropdown for Months -->
      <label for="month">Select Month:</label>
      <select id="month" name="month">
        <option value="" disabled selected>Select Month</option>
        <option value="2024-01">January</option>
        <option value="2024-02">February</option>
        <option value="2024-03">March</option>
        <option value="2024-04">April</option>
        <option value="2024-05">May</option>
        <option value="2024-06">June</option>
        <option value="2024-07">July</option>
        <option value="2024-08">August</option>
        <option value="2024-09">September</option>
        <option value="2024-10">October</option>
        <option value="2024-11">November</option>
        <option value="2024-12">December</option>
      </select>

      <button class="show-btn" onclick="fetchAndRenderGraph()">Show</button>
    </div>
    <div class="chart-section">
      <canvas id="barChart" width="400" height="200"></canvas>
    </div>
  </main>
</div>

<script>
  async function fetchAndRenderGraph() {
    try {
      // Retrieve filter values
      const location = document.getElementById('location').value;
      const crop = document.getElementById('crop').value;
      const month = document.getElementById('month').value;
      const priceType = document.getElementById('priceType').value;

      // Ensure all filters are selected
      if (!location || !crop || !month || !priceType) {
        alert('Please select all filters before displaying the chart.');
        return;
      }

      // Fetch data from the backend API
      const response = await fetch(`/api/pricing-graph?location=${location}&crop=${crop}&month=${month}&priceType=${priceType}`);

      if (!response.ok) {
        const errorMessage = await response.text();
        alert(`Failed to fetch data: ${errorMessage}`);
        return;
      }

      const data = await response.json();

      // Check if data is available
      if (data.length > 0) {
        const dates = data.map(item => item.update_date); // Extract dates
        const prices = data.map(item => item.price); // Extract prices
        renderBarChart(dates, prices);
      } else {
        alert('No data available for the selected filters.');
      }
    } catch (error) {
      console.error('Error fetching graph data:', error);
      alert('An error occurred while fetching the graph data.');
    }
  }

  function renderBarChart(labels, data) {
    const ctx = document.getElementById('barChart').getContext('2d');

    // Destroy existing chart instance if it exists
    if (window.barChartInstance) {
      window.barChartInstance.destroy();
    }

    // Create a new bar chart
    window.barChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Price Per Month',
          data: data,
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Dates'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Prices'
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>
